###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         06/Jun/2012  13:34:06 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\Source\OSAL_ZNP.c                              #
#    Command line       =  -f E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\..\Source\znp.cfg                    #
#                          (-DMAC_CFG_APP_PENDING_QUEUE=TRUE                  #
#                          "-DZSTACK_DEVICE_BUILD=(DEVICE_BUILD_COORDINATOR   #
#                          | DEVICE_BUILD_ROUTER | DEVICE_BUILD_ENDDEVICE)"   #
#                          -DNWK_AUTO_POLL -DZNP_RUN_WDOG=FALSE               #
#                          -DZNP_UART_BAUD=HAL_UART_BR_115200 -DZIGBEEPRO     #
#                          -DZIGBEE_FRAGMENTATION -DINTER_PAN -DOSAL_CLOCK    #
#                          -DOSAL_SAPI=FALSE -DSAPI_CB_FUNC=FALSE             #
#                          -DHOLD_AUTO_START -DNV_RESTORE -DNV_INIT           #
#                          -DNUM_DISC_ATTEMPTS=0 -DMT_UTIL_FUNC               #
#                          -DMT_SYS_FUNC -DMT_AF_FUNC -DMT_SAPI_FUNC          #
#                          -DMT_SAPI_CB_FUNC -DMT_ZDO_CB_FUNC -DMT_ZDO_FUNC   #
#                          -DMT_ZDO_MGMT -DMT_APP_FUNC) -f                    #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\Tools\CC2530DB\f8wConfig.cfg      #
#                          (-DZIGBEEPRO -DSECURE=0 -DZG_SECURE_DYNAMIC=0      #
#                          -DREFLECTOR -DDEFAULT_CHANLIST=0x00000800          #
#                          -DZDAPP_CONFIG_PAN_ID=0x1235                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100    #
#                          -DREJOIN_POLL_RATE=440) -f                         #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\Tools\CC2530DB\f8wZCL.cfg         #
#                          (-DZCL_READ -DZCL_WRITE -DZCL_BASIC                #
#                          -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH    #
#                          -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4     #
#                          -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10    #
#                          -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10   #
#                          -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING           #
#                          -DZCL_PRICING -DZCL_MESSAGE -DZCL_TUNNELING        #
#                          -DZCL_TOU) -DZCL_DEVICE_MGMT                       #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\Source\OSAL_ZNP.c -D POWER_SAVING -lC          #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\CC2530-Debug\List\ -lA                  #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\CC2530-Debug\List\ --diag_suppress      #
#                          Pe001,Pa010 -o E:\ChinaSoft\ZStack-CC2530-2.5.1a\P #
#                          rojects\zstack\ZNP\CC253x\CC2530-Debug\Obj\ -e     #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\ -I E:\ChinaSoft\ZStack-CC2530-2.5.1 #
#                          a\Projects\zstack\ZNP\CC253x\Source\ -I            #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\Source\ -I                           #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\SE\Source\ -I                     #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\ZMain\TI2530ZNP\ -I               #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\..\..\Components\hal\include\ -I  #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\..\..\Components\hal\target\CC253 #
#                          0ZNP\ -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Project #
#                          s\zstack\ZNP\CC253x\..\..\..\..\Components\mac\inc #
#                          lude\ -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Project #
#                          s\zstack\ZNP\CC253x\..\..\..\..\Components\mac\hig #
#                          h_level\ -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Proj #
#                          ects\zstack\ZNP\CC253x\..\..\..\..\Components\mac\ #
#                          low_level\srf04\ -I E:\ChinaSoft\ZStack-CC2530-2.5 #
#                          .1a\Projects\zstack\ZNP\CC253x\..\..\..\..\Compone #
#                          nts\mac\low_level\srf04\single_chip\ -I            #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\..\..\Components\mt\ -I           #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\..\..\Components\osal\include\    #
#                          -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\..\..\..\..\Components\services\sadd #
#                          r\ -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\z #
#                          stack\ZNP\CC253x\..\..\..\..\Components\services\s #
#                          data\ -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Project #
#                          s\zstack\ZNP\CC253x\..\..\..\..\Components\stack\a #
#                          f\ -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\z #
#                          stack\ZNP\CC253x\..\..\..\..\Components\stack\nwk\ #
#                           -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zst #
#                          ack\ZNP\CC253x\..\..\..\..\Components\stack\sapi\  #
#                          -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\..\..\..\..\Components\stack\sec\    #
#                          -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\..\..\..\..\Components\stack\sys\    #
#                          -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\..\..\..\..\Components\stack\zcl\    #
#                          -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\..\..\..\..\Components\stack\zdo\    #
#                          -I E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zsta #
#                          ck\ZNP\CC253x\..\..\..\..\Components\zmac\ -I      #
#                          E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\..\..\..\..\Components\zmac\f8w\ -Ohz   #
#                          --require_prototypes                               #
#    List file          =  E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\CC2530-Debug\List\OSAL_ZNP.lst          #
#    Object file        =  E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ #
#                          ZNP\CC253x\CC2530-Debug\Obj\OSAL_ZNP.r51           #
#                                                                             #
#                                                                             #
###############################################################################

E:\ChinaSoft\ZStack-CC2530-2.5.1a\Projects\zstack\ZNP\Source\OSAL_ZNP.c
      1          /**************************************************************************************************
      2            Filename:       OSAL_ZNP.c
      3            Revised:        $Date: 2010-08-12 16:15:23 -0700 (Thu, 12 Aug 2010) $
      4            Revision:       $Revision: 23398 $
      5          
      6            Description:    This file is the Application-specific mandatory OSAL file.
      7          
      8          
      9            Copyright 2009-2010 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41           * INCLUDES
     42           */
     43          
     44          #include "ZComDef.h"
     45          #include "hal_drivers.h"
     46          #include "hal_mcu.h"

   \                                 In  segment SFR_AN, at 0xa8
   \   union <unnamed> volatile __sfr _A_IEN0
   \                     _A_IEN0:
   \   000000                DS 1
     47          #include "OSAL.h"
     48          #include "OSAL_Clock.h"
     49          #include "OSAL_PwrMgr.h"
     50          #include "OSAL_Tasks.h"
     51          
     52          #include "MT.h"
     53          #include "MT_TASK.h"
     54          
     55          #include "nwk.h"
     56          #include "APS.h"
     57          #include "ZDApp.h"
     58          #if defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )
     59          #include "ZDNwkMgr.h"
     60          #endif
     61          #if defined ( ZIGBEE_FRAGMENTATION )
     62          #include "aps_frag.h"
     63          #endif
     64          #if defined ( INTER_PAN )
     65          #include "stub_aps.h"
     66          #endif
     67          #include "sapi.h"
     68          #include "znp_app.h"
     69          #if defined ( ZCL_KEY_ESTABLISH )
     70            #include "zcl_key_establish.h"
     71          #endif
     72          
     73          /*********************************************************************
     74           * GLOBAL VARIABLES
     75           */
     76          
     77          // The order in this table must be identical to the task initialization calls below in osalInitTask.

   \                                 In  segment XDATA_ROM_C, align 1
     78          const pTaskEventHandlerFn tasksArr[] = {
   \                     tasksArr:
   \   000000   ....         DW ??znpEventLoop?relay
   \   000002   ....         DW ??macEventLoop?relay
   \   000004   ....         DW ??nwk_event_loop?relay
   \   000006   ....         DW ??APS_event_loop?relay
   \   000008   ....         DW ??APSF_ProcessEvent?relay
   \   00000A   ....         DW ??ZDApp_event_loop?relay
   \   00000C   ....         DW ??ZDNwkMgr_event_loop?relay
   \   00000E   ....         DW ??StubAPS_ProcessEvent?relay
   \   000010   ....         DW ??SAPI_ProcessEvent?relay
   \   000012   ....         DW ??Hal_ProcessEvent?relay
     79            znpEventLoop,
     80            macEventLoop,
     81            nwk_event_loop,
     82            APS_event_loop,
     83          #if defined ( ZIGBEE_FRAGMENTATION )
     84            APSF_ProcessEvent,
     85          #endif
     86            ZDApp_event_loop,
     87          #if defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )
     88            ZDNwkMgr_event_loop,
     89          #endif
     90          #if defined( INTER_PAN )
     91            StubAPS_ProcessEvent,
     92          #endif
     93            SAPI_ProcessEvent,
     94          #if defined ( TC_LINKKEY_JOIN )
     95            zclKeyEstablish_event_loop,
     96          #endif
     97            Hal_ProcessEvent
     98          };
     99          

   \                                 In  segment XDATA_ROM_C, align 1
    100          const uint8 tasksCnt = sizeof( tasksArr ) / sizeof( tasksArr[0] );
   \                     tasksCnt:
   \   000000   0A           DB 10

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    101          uint16 *tasksEvents;
   \                     tasksEvents:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    102          
    103          /*********************************************************************
    104           * FUNCTIONS
    105           *********************************************************************/
    106          
    107          void osal_start_znp(void);
    108          static void osal_run_task(uint8 idx);
    109          
    110          /*********************************************************************
    111           * @fn      osalInitTasks
    112           *
    113           * @brief   This function invokes the initialization function for each task.
    114           *
    115           * @param   void
    116           *
    117           * @return  none
    118           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    119          void osalInitTasks( void )
   \                     osalInitTasks:
    120          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    121            uint8 taskID = 0;
    122          
    123            tasksEvents = (uint16 *)osal_mem_alloc( sizeof( uint16 ) * tasksCnt);
   \   000004                ; Setup parameters for call to function osal_mem_alloc
   \   000004   7A14         MOV     R2,#0x14
   \   000006   7B00         MOV     R3,#0x0
   \   000008   12....       LCALL   ??osal_mem_alloc?relay
   \   00000B   90....       MOV     DPTR,#tasksEvents
   \   00000E   EA           MOV     A,R2
   \   00000F   F0           MOVX    @DPTR,A
   \   000010   A3           INC     DPTR
   \   000011   EB           MOV     A,R3
   \   000012   F0           MOVX    @DPTR,A
    124            osal_memset( tasksEvents, 0, (sizeof( uint16 ) * tasksCnt));
   \   000013                ; Setup parameters for call to function osal_memset
   \   000013   7C14         MOV     R4,#0x14
   \   000015   7D00         MOV     R5,#0x0
   \   000017   7900         MOV     R1,#0x0
   \   000019   12....       LCALL   ??osal_memset?relay
    125          
    126            znpInit( taskID++ );
   \   00001C                ; Setup parameters for call to function znpInit
   \   00001C   7900         MOV     R1,#0x0
   \   00001E   12....       LCALL   ??znpInit?relay
    127            macTaskInit( taskID++ );
   \   000021                ; Setup parameters for call to function macTaskInit
   \   000021   7901         MOV     R1,#0x1
   \   000023   12....       LCALL   ??macTaskInit?relay
    128            nwk_init( taskID++ );
   \   000026                ; Setup parameters for call to function nwk_init
   \   000026   7902         MOV     R1,#0x2
   \   000028   12....       LCALL   ??nwk_init?relay
    129            APS_Init( taskID++ );
   \   00002B                ; Setup parameters for call to function APS_Init
   \   00002B   7903         MOV     R1,#0x3
   \   00002D   12....       LCALL   ??APS_Init?relay
    130          #if defined ( ZIGBEE_FRAGMENTATION )
    131            APSF_Init( taskID++ );
   \   000030                ; Setup parameters for call to function APSF_Init
   \   000030   7904         MOV     R1,#0x4
   \   000032   12....       LCALL   ??APSF_Init?relay
    132          #endif
    133            ZDApp_Init( taskID++ );
   \   000035                ; Setup parameters for call to function ZDApp_Init
   \   000035   7905         MOV     R1,#0x5
   \   000037   12....       LCALL   ??ZDApp_Init?relay
    134          #if defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )
    135            ZDNwkMgr_Init( taskID++ );
   \   00003A                ; Setup parameters for call to function ZDNwkMgr_Init
   \   00003A   7906         MOV     R1,#0x6
   \   00003C   12....       LCALL   ??ZDNwkMgr_Init?relay
    136          #endif
    137          #if defined( INTER_PAN )
    138            StubAPS_Init( taskID++ );
   \   00003F                ; Setup parameters for call to function StubAPS_Init
   \   00003F   7907         MOV     R1,#0x7
   \   000041   12....       LCALL   ??StubAPS_Init?relay
    139          #endif
    140            SAPI_Init( taskID++ );
   \   000044                ; Setup parameters for call to function SAPI_Init
   \   000044   7908         MOV     R1,#0x8
   \   000046   12....       LCALL   ??SAPI_Init?relay
    141          #if defined ( TC_LINKKEY_JOIN )
    142            zclGeneral_KeyEstablish_Init( taskID++ );
    143          #endif
    144            Hal_Init( taskID );
   \   000049                ; Setup parameters for call to function Hal_Init
   \   000049   7909         MOV     R1,#0x9
   \   00004B   12....       LCALL   ??Hal_Init?relay
    145          }
   \   00004E   D083         POP     DPH
   \   000050   D082         POP     DPL
   \   000052   02....       LJMP    ?BRET
    146          
    147          /*********************************************************************
    148           * @fn      osal_start_znp
    149           *
    150           * @brief
    151           *
    152           *   This function is the main loop function of the task system.  It
    153           *   will look through all task events and call the task_event_processor()
    154           *   function for the task with the event.  If there are no events (for
    155           *   all tasks), this function puts the processor into Sleep.
    156           *   This Function doesn't return.
    157           *
    158           * @param   void
    159           *
    160           * @return  none
    161           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    162          void osal_start_znp( void )
   \                     osal_start_znp:
    163          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   8008         SJMP    ??osal_start_znp_0
    164          #if !defined ( ZBIT ) && !defined ( UBIT )
    165            for(;;)  // Forever Loop
    166          #endif
    167            {
    168          #if defined( POWER_SAVING )
    169              uint8 busy = FALSE;
    170          #endif
    171              uint8 idx;
    172          
    173              osalTimeUpdate();
    174              Hal_ProcessPoll();
    175          
    176              for (idx = 1; idx < tasksCnt; idx++)
    177              {
    178                if (tasksEvents[idx])
    179                {
    180                  osal_run_task(idx);
    181          #if defined( POWER_SAVING )
    182                  busy = TRUE;
    183          #endif
    184                  break;
    185                }
    186              }
    187          
    188              if (tasksEvents[0])  // Always run the ZNP task.
    189              {
    190                osal_run_task(0);
    191          #if defined( POWER_SAVING )
    192                busy = TRUE;
    193          #endif
    194              }
    195          
    196          #if defined( POWER_SAVING )
    197              if (!busy)  // Complete pass through all task events with no activity?
   \                     ??osal_start_znp_1:
   \   000007   EE           MOV     A,R6
   \   000008   A2E0         MOV     C,0xE0 /* A   */.0
   \   00000A   4003         JC      ??osal_start_znp_0
    198              {
    199                osal_pwrmgr_powerconserve();  // Put the processor/system into sleep.
   \   00000C                ; Setup parameters for call to function osal_pwrmgr_powerconserve
   \   00000C   12....       LCALL   ??osal_pwrmgr_powerconserve?relay
    200              }
   \                     ??osal_start_znp_0:
   \   00000F   7E00         MOV     R6,#0x0
   \   000011                ; Setup parameters for call to function osalTimeUpdate
   \   000011   12....       LCALL   ??osalTimeUpdate?relay
   \   000014                ; Setup parameters for call to function Hal_ProcessPoll
   \   000014   12....       LCALL   ??Hal_ProcessPoll?relay
   \   000017   7901         MOV     R1,#0x1
   \                     ??osal_start_znp_2:
   \   000019   E9           MOV     A,R1
   \   00001A   C3           CLR     C
   \   00001B   33           RLC     A
   \   00001C   FA           MOV     R2,A
   \   00001D   E4           CLR     A
   \   00001E   33           RLC     A
   \   00001F   FB           MOV     R3,A
   \   000020   90....       MOV     DPTR,#tasksEvents
   \   000023   E0           MOVX    A,@DPTR
   \   000024   2A           ADD     A,R2
   \   000025   F8           MOV     R0,A
   \   000026   A3           INC     DPTR
   \   000027   E0           MOVX    A,@DPTR
   \   000028   3B           ADDC    A,R3
   \   000029   8882         MOV     DPL,R0
   \   00002B   F583         MOV     DPH,A
   \   00002D   E0           MOVX    A,@DPTR
   \   00002E   FA           MOV     R2,A
   \   00002F   A3           INC     DPTR
   \   000030   E0           MOVX    A,@DPTR
   \   000031   FB           MOV     R3,A
   \   000032   EA           MOV     A,R2
   \   000033   4B           ORL     A,R3
   \   000034   6006         JZ      ??osal_start_znp_3
   \   000036                ; Setup parameters for call to function osal_run_task
   \   000036   12....       LCALL   ??osal_run_task?relay
   \   000039   0E           INC     R6
   \   00003A   8007         SJMP    ??osal_start_znp_4
   \                     ??osal_start_znp_3:
   \   00003C   09           INC     R1
   \   00003D   E9           MOV     A,R1
   \   00003E   C3           CLR     C
   \   00003F   940A         SUBB    A,#0xa
   \   000041   40D6         JC      ??osal_start_znp_2
   \                     ??osal_start_znp_4:
   \   000043   90....       MOV     DPTR,#tasksEvents
   \   000046   12....       LCALL   ?Subroutine0 & 0xFFFF
   \                     ??CrossCallReturnLabel_0:
   \   000049   E0           MOVX    A,@DPTR
   \   00004A   F8           MOV     R0,A
   \   00004B   A3           INC     DPTR
   \   00004C   E0           MOVX    A,@DPTR
   \   00004D   F9           MOV     R1,A
   \   00004E   E8           MOV     A,R0
   \   00004F   49           ORL     A,R1
   \   000050   60B5         JZ      ??osal_start_znp_1
   \   000052                ; Setup parameters for call to function osal_run_task
   \   000052   7900         MOV     R1,#0x0
   \   000054   12....       LCALL   ??osal_run_task?relay
   \   000057   80B6         SJMP    ??osal_start_znp_0
    201          #endif
    202            }
    203          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F8           MOV     R0,A
   \   000002   A3           INC     DPTR
   \   000003   E0           MOVX    A,@DPTR
   \   000004   F583         MOV     DPH,A
   \   000006   8882         MOV     DPL,R0
   \   000008   22           RET
    204          
    205          /*********************************************************************
    206           * @fn      osal_run_task
    207           *
    208           * @brief
    209           *
    210           *   This function is the main loop function of the task system.  It
    211           *   will look through all task events and call the task_event_processor()
    212           *   function for the task with the event.  If there are no events (for
    213           *   all tasks), this function puts the processor into Sleep.
    214           *   This Function doesn't return.
    215           *
    216           * @param   void
    217           *
    218           * @return  none
    219           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    220          static void osal_run_task(uint8 idx)
   \                     osal_run_task:
    221          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
    222            uint16 events;
    223            halIntState_t intState;
    224          
    225            HAL_ENTER_CRITICAL_SECTION(intState);
   \   000007   E5A8         MOV     A,0xa8
   \   000009   FC           MOV     R4,A
   \   00000A   C2AF         CLR     0xa8.7
    226            events = tasksEvents[idx];
   \   00000C   E9           MOV     A,R1
   \   00000D   C3           CLR     C
   \   00000E   33           RLC     A
   \   00000F   FE           MOV     R6,A
   \   000010   E4           CLR     A
   \   000011   33           RLC     A
   \   000012   FF           MOV     R7,A
   \   000013   90....       MOV     DPTR,#tasksEvents
   \   000016   E0           MOVX    A,@DPTR
   \   000017   2E           ADD     A,R6
   \   000018   F8           MOV     R0,A
   \   000019   A3           INC     DPTR
   \   00001A   E0           MOVX    A,@DPTR
   \   00001B   3F           ADDC    A,R7
   \   00001C   F9           MOV     R1,A
   \   00001D   8882         MOV     DPL,R0
   \   00001F   8983         MOV     DPH,R1
   \   000021   E0           MOVX    A,@DPTR
   \   000022   FA           MOV     R2,A
   \   000023   A3           INC     DPTR
   \   000024   E0           MOVX    A,@DPTR
   \   000025   FB           MOV     R3,A
    227            tasksEvents[idx] = 0;  // Clear the Events for this task.
   \   000026   8882         MOV     DPL,R0
   \   000028   8983         MOV     DPH,R1
   \   00002A   E4           CLR     A
   \   00002B   F0           MOVX    @DPTR,A
   \   00002C   A3           INC     DPTR
   \   00002D   F0           MOVX    @DPTR,A
    228            HAL_EXIT_CRITICAL_SECTION(intState);
   \   00002E   EC           MOV     A,R4
   \   00002F   A2E7         MOV     C,0xE0 /* A   */.7
   \   000031   92AF         MOV     0xa8.7,C
    229          
    230            events = (tasksArr[idx])( idx, events );
   \   000033                ; Setup parameters for indirect call
   \   000033   A9..         MOV     R1,?V0 + 0
   \   000035   74..         MOV     A,#tasksArr & 0xff
   \   000037   2E           ADD     A,R6
   \   000038   F582         MOV     DPL,A
   \   00003A   74..         MOV     A,#(tasksArr >> 8) & 0xff
   \   00003C   3F           ADDC    A,R7
   \   00003D   F583         MOV     DPH,A
   \   00003F   12....       LCALL   ?Subroutine0 & 0xFFFF
   \                     ??CrossCallReturnLabel_1:
   \   000042   12....       LCALL   ?CALL_IND
    231          
    232            HAL_ENTER_CRITICAL_SECTION(intState);
   \   000045   E5A8         MOV     A,0xa8
   \   000047   F9           MOV     R1,A
   \   000048   C2AF         CLR     0xa8.7
    233            tasksEvents[idx] |= events;  // Add back unprocessed events to the current task.
   \   00004A   90....       MOV     DPTR,#tasksEvents
   \   00004D   E0           MOVX    A,@DPTR
   \   00004E   2E           ADD     A,R6
   \   00004F   F8           MOV     R0,A
   \   000050   A3           INC     DPTR
   \   000051   E0           MOVX    A,@DPTR
   \   000052   3F           ADDC    A,R7
   \   000053   8882         MOV     DPL,R0
   \   000055   F583         MOV     DPH,A
   \   000057   E0           MOVX    A,@DPTR
   \   000058   4A           ORL     A,R2
   \   000059   F0           MOVX    @DPTR,A
   \   00005A   A3           INC     DPTR
   \   00005B   E0           MOVX    A,@DPTR
   \   00005C   4B           ORL     A,R3
   \   00005D   F0           MOVX    @DPTR,A
    234            HAL_EXIT_CRITICAL_SECTION(intState);
   \   00005E   E9           MOV     A,R1
   \   00005F   A2E7         MOV     C,0xE0 /* A   */.7
   \   000061   92AF         MOV     0xa8.7,C
    235          }
   \   000063   7F04         MOV     R7,#0x4
   \   000065   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000068                REQUIRE _A_IEN0

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??osalInitTasks?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    osalInitTasks

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??osal_start_znp?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    osal_start_znp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??osal_run_task?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    osal_run_task
    236          
    237          /*********************************************************************
    238          *********************************************************************/

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     osalInitTasks                      2      0      0
       -> osal_mem_alloc                4      0      0
       -> osal_memset                   4      0      0
       -> znpInit                       4      0      0
       -> macTaskInit                   4      0      0
       -> nwk_init                      4      0      0
       -> APS_Init                      4      0      0
       -> APSF_Init                     4      0      0
       -> ZDApp_Init                    4      0      0
       -> ZDNwkMgr_Init                 4      0      0
       -> StubAPS_Init                  4      0      0
       -> SAPI_Init                     4      0      0
       -> Hal_Init                      4      0      0
     osal_run_task                      0      0     21
     osal_start_znp                     0      0      9
       -> osal_pwrmgr_powerconserve     0      0     18
       -> osalTimeUpdate                0      0     18
       -> Hal_ProcessPoll               0      0     18
       -> osal_run_task                 0      0     18
       -> osal_run_task                 0      0     18


   Segment part sizes:

     Function/Label         Bytes
     --------------         -----
     _A_IEN0                   1
     tasksArr                 20
     tasksCnt                  1
     tasksEvents               2
     osalInitTasks            85
     osal_start_znp           89
     ?Subroutine0              9
     osal_run_task           104
     ??osalInitTasks?relay     6
     ??osal_start_znp?relay    6
     ??osal_run_task?relay     6

 
 287 bytes in segment BANKED_CODE
  18 bytes in segment BANK_RELAYS
   1 byte  in segment SFR_AN
  21 bytes in segment XDATA_ROM_C
   2 bytes in segment XDATA_Z
 
 305 bytes of CODE  memory
  21 bytes of CONST memory
   0 bytes of DATA  memory (+ 1 byte shared)
   2 bytes of XDATA memory

Errors: none
Warnings: none
