/**************************************************************************************************
  Filename:       hal_lcd.c
  Revised:        $Date: 2010-06-21 17:31:27 -0700 (Mon, 21 Jun 2010) $
  Revision:       $Revision: 22794 $

  Description:    This file contains the interface to the HAL LCD Service.


  Copyright 2007-2010 Texas Instruments Incorporated. All rights reserved.

  IMPORTANT: Your use of this Software is limited to those specific rights
  granted under the terms of a software license agreement between the user
  who downloaded the software, his/her employer (which must be your employer)
  and Texas Instruments Incorporated (the "License").  You may not use this
  Software unless you agree to abide by the terms of the License. The License
  limits your use, and you acknowledge, that the Software may not be modified,
  copied or distributed unless embedded on a Texas Instruments microcontroller
  or used solely and exclusively in conjunction with a Texas Instruments radio
  frequency transceiver, which is integrated into your product.  Other than for
  the foregoing purpose, you may not use, reproduce, copy, prepare derivative
  works of, modify, distribute, perform, display or sell this Software and/or
  its documentation for any purpose.

  YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
  PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
  INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
  NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
  TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
  NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
  LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
  INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
  OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
  OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
  (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.

  Should you have any questions regarding your right to use this Software,
  contact Texas Instruments Incorporated at www.TI.com.
**************************************************************************************************/

/**************************************************************************************************
 *                                           INCLUDES
 **************************************************************************************************/
#include "hal_types.h"
#include "hal_lcd.h"
#include "OSAL.h"
#include "OnBoard.h"
#include "hal_assert.h"

#if defined (ZTOOL_P1) || defined (ZTOOL_P2)
  #include "DebugTrace.h"
#endif

#ifdef LCD_SUPPORTED
/**************************************************************************************************
 *                                          CONSTANTS
 **************************************************************************************************/
/*
  LCD pins
  //spi  由于通过164转接，只能写数据，不能读取LCD RAM中的数据
  P1.5 - CLK
  P1.6 - MOSI
  P1.4 - CS
  P2.1 - CLR  低电平有效
  P0.7 - RS
  P0.6 - WR
  P0.5 - RD
*/
#define HAL_LCD_CS_PORT   1  //CS = P1_4
#define HAL_LCD_CS_PIN    4

/* LCD SPI lines */
#define HAL_LCD_MISO_PORT 1
#define HAL_LCD_MISO_PIN  7

#define HAL_LCD_CLK_PORT  1  //SCK = P1_5
#define HAL_LCD_CLK_PIN   5

#define HAL_LCD_MOSI_PORT 1  //MOSI = P1_6
#define HAL_LCD_MOSI_PIN  6

#define HAL_LCD_RS_PORT   0  //RS = P0_7
#define HAL_LCD_RS_PIN    7

#define HAL_LCD_WR_PORT   0  //WR = P0_6
#define HAL_LCD_WR_PIN    6

#define HAL_LCD_RD_PORT   0  //RD = P0_5
#define HAL_LCD_RD_PIN    5

#define HAL_LCD_RST_PORT  1  //RD = P0_5
#define HAL_LCD_RST_PIN   3

#define LCD_CS            P1_4
#define LCD_RS            P0_7
#define LCD_WR            P0_6
#define LCD_RD            P0_5
#define LCD_RST           P1_3

/* SPI settings */
#define HAL_SPI_CLOCK_POL_LO        0x00
#define HAL_SPI_CLOCK_PHA_0         0x00
#define HAL_SPI_TRANSFER_MSB_FIRST  0x20

/**************************************************************************************************
 *                                           MACROS
 **************************************************************************************************/
#define HAL_IO_SET(port, pin, val)        HAL_IO_SET_PREP(port, pin, val)
#define HAL_IO_SET_PREP(port, pin, val)   st( P##port##_##pin## = val; )

#define HAL_CONFIG_IO_OUTPUT(port, pin, val)      HAL_CONFIG_IO_OUTPUT_PREP(port, pin, val)
#define HAL_CONFIG_IO_OUTPUT_PREP(port, pin, val) st( P##port##SEL &= ~BV(pin); \
                                                      P##port##_##pin## = val; \
                                                      P##port##DIR |= BV(pin); )

#define HAL_CONFIG_IO_PERIPHERAL(port, pin)      HAL_CONFIG_IO_PERIPHERAL_PREP(port, pin)
#define HAL_CONFIG_IO_PERIPHERAL_PREP(port, pin) st( P##port##SEL |= BV(pin); )

/* clear the received and transmit byte status, write tx data to buffer, wait till transmit done */
#define LCD_SPI_TX(x)                   { U1CSR &= ~(BV(2) | BV(1)); U1DBUF = x; while( !(U1CSR & BV(1)) ); }
#define LCD_SPI_WAIT_RXRDY()            { while(!(U1CSR & BV(1))); }

uint16  PointColor = BLACK;
uint16  BackColor  = WHITE;
//ASCII码，16*16点阵 横向取模 高位在前 宋体 共95*16=1520个字节，即占RAM大约1K半 
const uint8 ascii_16[95][16]={
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*" ",0*/
                              {0x00,0x00,0x00,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x00,0x00,0x18,0x18,0x00,0x00},/*"!",1*/
                              {0x00,0x12,0x36,0x24,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*""",2*/
                              {0x00,0x00,0x00,0x24,0x24,0x24,0xFE,0x48,0x48,0x48,0xFE,0x48,0x48,0x48,0x00,0x00},/*"#",3*/
                              {0x00,0x00,0x10,0x38,0x54,0x54,0x50,0x30,0x18,0x14,0x14,0x54,0x54,0x38,0x10,0x10},/*"$",4*/
                              {0x00,0x00,0x00,0x44,0xA4,0xA8,0xA8,0xA8,0x54,0x1A,0x2A,0x2A,0x2A,0x44,0x00,0x00},/*"%",5*/
                              {0x00,0x00,0x00,0x30,0x48,0x48,0x48,0x50,0x6E,0xA4,0x94,0x88,0x89,0x76,0x00,0x00},/*"&",6*/
                              {0x00,0x60,0x60,0x20,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"'",7*/
                              {0x00,0x02,0x04,0x08,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x08,0x08,0x04,0x02,0x00},/*"(",8*/
                              {0x00,0x40,0x20,0x10,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x10,0x20,0x40,0x00},/*")",9*/
                              {0x00,0x00,0x00,0x00,0x10,0x10,0xD6,0x38,0x38,0xD6,0x10,0x10,0x00,0x00,0x00,0x00},/*"*",10*/
                              {0x00,0x00,0x00,0x00,0x10,0x10,0x10,0x10,0xFE,0x10,0x10,0x10,0x10,0x00,0x00,0x00},/*"+",11*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x60,0x20,0xC0},/*",",12*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"-",13*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x60,0x00,0x00},/*".",14*/
                              {0x00,0x00,0x01,0x02,0x02,0x04,0x04,0x08,0x08,0x10,0x10,0x20,0x20,0x40,0x40,0x00},/*"/",15*/
                              {0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18,0x00,0x00},/*"0",16*/
                              {0x00,0x00,0x00,0x10,0x70,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00},/*"1",17*/
                              {0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x04,0x04,0x08,0x10,0x20,0x42,0x7E,0x00,0x00},/*"2",18*/
                              {0x00,0x00,0x00,0x3C,0x42,0x42,0x04,0x18,0x04,0x02,0x02,0x42,0x44,0x38,0x00,0x00},/*"3",19*/
                              {0x00,0x00,0x00,0x04,0x0C,0x14,0x24,0x24,0x44,0x44,0x7E,0x04,0x04,0x1E,0x00,0x00},/*"4",20*/
                              {0x00,0x00,0x00,0x7E,0x40,0x40,0x40,0x58,0x64,0x02,0x02,0x42,0x44,0x38,0x00,0x00},/*"5",21*/
                              {0x00,0x00,0x00,0x1C,0x24,0x40,0x40,0x58,0x64,0x42,0x42,0x42,0x24,0x18,0x00,0x00},/*"6",22*/
                              {0x00,0x00,0x00,0x7E,0x44,0x44,0x08,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x00,0x00},/*"7",23*/
                              {0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x24,0x18,0x24,0x42,0x42,0x42,0x3C,0x00,0x00},/*"8",24*/
                              {0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,0x26,0x1A,0x02,0x02,0x24,0x38,0x00,0x00},/*"9",25*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00},/*":",26*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x10,0x10,0x20},/*";",27*/
                              {0x00,0x00,0x00,0x02,0x04,0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x04,0x02,0x00,0x00},/*"<",28*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00},/*"=",29*/
                              {0x00,0x00,0x00,0x40,0x20,0x10,0x08,0x04,0x02,0x04,0x08,0x10,0x20,0x40,0x00,0x00},/*">",30*/
                              {0x00,0x00,0x00,0x3C,0x42,0x42,0x62,0x02,0x04,0x08,0x08,0x00,0x18,0x18,0x00,0x00},/*"?",31*/
                              {0x00,0x00,0x00,0x38,0x44,0x5A,0xAA,0xAA,0xAA,0xAA,0xB4,0x42,0x44,0x38,0x00,0x00},/*"@",32*/
                              {0x00,0x00,0x00,0x10,0x10,0x18,0x28,0x28,0x24,0x3C,0x44,0x42,0x42,0xE7,0x00,0x00},/*"A",33*/
                              {0x00,0x00,0x00,0xF8,0x44,0x44,0x44,0x78,0x44,0x42,0x42,0x42,0x44,0xF8,0x00,0x00},/*"B",34*/
                              {0x00,0x00,0x00,0x3E,0x42,0x42,0x80,0x80,0x80,0x80,0x80,0x42,0x44,0x38,0x00,0x00},/*"C",35*/
                              {0x00,0x00,0x00,0xF8,0x44,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x44,0xF8,0x00,0x00},/*"D",36*/
                              {0x00,0x00,0x00,0xFC,0x42,0x48,0x48,0x78,0x48,0x48,0x40,0x42,0x42,0xFC,0x00,0x00},/*"E",37*/
                              {0x00,0x00,0x00,0xFC,0x42,0x48,0x48,0x78,0x48,0x48,0x40,0x40,0x40,0xE0,0x00,0x00},/*"F",38*/
                              {0x00,0x00,0x00,0x3C,0x44,0x44,0x80,0x80,0x80,0x8E,0x84,0x44,0x44,0x38,0x00,0x00},/*"G",39*/
                              {0x00,0x00,0x00,0xE7,0x42,0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x42,0xE7,0x00,0x00},/*"H",40*/
                              {0x00,0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00},/*"I",41*/
                              {0x00,0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x88,0xF0},/*"J",42*/
                              {0x00,0x00,0x00,0xEE,0x44,0x48,0x50,0x70,0x50,0x48,0x48,0x44,0x44,0xEE,0x00,0x00},/*"K",43*/
                              {0x00,0x00,0x00,0xE0,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x42,0xFE,0x00,0x00},/*"L",44*/
                              {0x00,0x00,0x00,0xEE,0x6C,0x6C,0x6C,0x6C,0x54,0x54,0x54,0x54,0x54,0xD6,0x00,0x00},/*"M",45*/
                              {0x00,0x00,0x00,0xC7,0x62,0x62,0x52,0x52,0x4A,0x4A,0x4A,0x46,0x46,0xE2,0x00,0x00},/*"N",46*/
                              {0x00,0x00,0x00,0x38,0x44,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x44,0x38,0x00,0x00},/*"O",47*/
                              {0x00,0x00,0x00,0xFC,0x42,0x42,0x42,0x42,0x7C,0x40,0x40,0x40,0x40,0xE0,0x00,0x00},/*"P",48*/
                              {0x00,0x00,0x00,0x38,0x44,0x82,0x82,0x82,0x82,0x82,0xB2,0xCA,0x4C,0x38,0x06,0x00},/*"Q",49*/
                              {0x00,0x00,0x00,0xFC,0x42,0x42,0x42,0x7C,0x48,0x48,0x44,0x44,0x42,0xE3,0x00,0x00},/*"R",50*/
                              {0x00,0x00,0x00,0x3E,0x42,0x42,0x40,0x20,0x18,0x04,0x02,0x42,0x42,0x7C,0x00,0x00},/*"S",51*/
                              {0x00,0x00,0x00,0xFE,0x92,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x38,0x00,0x00},/*"T",52*/
                              {0x00,0x00,0x00,0xE7,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00},/*"U",53*/
                              {0x00,0x00,0x00,0xE7,0x42,0x42,0x44,0x24,0x24,0x28,0x28,0x18,0x10,0x10,0x00,0x00},/*"V",54*/
                              {0x00,0x00,0x00,0xD6,0x92,0x92,0x92,0x92,0xAA,0xAA,0x6C,0x44,0x44,0x44,0x00,0x00},/*"W",55*/
                              {0x00,0x00,0x00,0xE7,0x42,0x24,0x24,0x18,0x18,0x18,0x24,0x24,0x42,0xE7,0x00,0x00},/*"X",56*/
                              {0x00,0x00,0x00,0xEE,0x44,0x44,0x28,0x28,0x10,0x10,0x10,0x10,0x10,0x38,0x00,0x00},/*"Y",57*/
                              {0x00,0x00,0x00,0x7E,0x84,0x04,0x08,0x08,0x10,0x20,0x20,0x42,0x42,0xFC,0x00,0x00},/*"Z",58*/
                              {0x00,0x1E,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x1E,0x00},/*"[",59*/
                              {0x00,0x00,0x40,0x40,0x20,0x20,0x10,0x10,0x10,0x08,0x08,0x04,0x04,0x04,0x02,0x02},/*"\",60*/
                              {0x00,0x78,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x78,0x00},/*"]",61*/
                              {0x00,0x1C,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"^",62*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},/*"_",63*/
                              {0x00,0x60,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"`",64*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x1E,0x22,0x42,0x42,0x3F,0x00,0x00},/*"a",65*/
                              {0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x58,0x64,0x42,0x42,0x42,0x64,0x58,0x00,0x00},/*"b",66*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0x22,0x40,0x40,0x40,0x22,0x1C,0x00,0x00},/*"c",67*/
                              {0x00,0x00,0x00,0x06,0x02,0x02,0x02,0x1E,0x22,0x42,0x42,0x42,0x26,0x1B,0x00,0x00},/*"d",68*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x7E,0x40,0x40,0x42,0x3C,0x00,0x00},/*"e",69*/
                              {0x00,0x00,0x00,0x0F,0x11,0x10,0x10,0x7E,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00},/*"f",70*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x44,0x44,0x38,0x40,0x3C,0x42,0x42,0x3C},/*"g",71*/
                              {0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x5C,0x62,0x42,0x42,0x42,0x42,0xE7,0x00,0x00},/*"h",72*/
                              {0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x70,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00},/*"i",73*/
                              {0x00,0x00,0x00,0x0C,0x0C,0x00,0x00,0x1C,0x04,0x04,0x04,0x04,0x04,0x04,0x44,0x78},/*"j",74*/
                              {0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x4E,0x48,0x50,0x68,0x48,0x44,0xEE,0x00,0x00},/*"k",75*/
                              {0x00,0x00,0x00,0x70,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00},/*"l",76*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x49,0x49,0x49,0x49,0x49,0xED,0x00,0x00},/*"m",77*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xDC,0x62,0x42,0x42,0x42,0x42,0xE7,0x00,0x00},/*"n",78*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00},/*"o",79*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xD8,0x64,0x42,0x42,0x42,0x44,0x78,0x40,0xE0},/*"p",80*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1E,0x22,0x42,0x42,0x42,0x22,0x1E,0x02,0x07},/*"q",81*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xEE,0x32,0x20,0x20,0x20,0x20,0xF8,0x00,0x00},/*"r",82*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x42,0x40,0x3C,0x02,0x42,0x7C,0x00,0x00},/*"s",83*/
                              {0x00,0x00,0x00,0x00,0x00,0x10,0x10,0x7C,0x10,0x10,0x10,0x10,0x10,0x0C,0x00,0x00},/*"t",84*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC6,0x42,0x42,0x42,0x42,0x46,0x3B,0x00,0x00},/*"u",85*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE7,0x42,0x24,0x24,0x28,0x10,0x10,0x00,0x00},/*"v",86*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xD7,0x92,0x92,0xAA,0xAA,0x44,0x44,0x00,0x00},/*"w",87*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x6E,0x24,0x18,0x18,0x18,0x24,0x76,0x00,0x00},/*"x",88*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE7,0x42,0x24,0x24,0x28,0x18,0x10,0x10,0xE0},/*"y",89*/
                              {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x44,0x08,0x10,0x10,0x22,0x7E,0x00,0x00},/*"z",90*/
                              {0x00,0x03,0x04,0x04,0x04,0x04,0x04,0x08,0x04,0x04,0x04,0x04,0x04,0x04,0x03,0x00},/*"{",91*/
                              {0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08},/*"|",92*/
                              {0x00,0x60,0x10,0x10,0x10,0x10,0x10,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x60,0x00},/*"}",93*/
                              {0x30,0x4C,0x43,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"~",94*/
};


#if (HAL_LCD == TRUE)

static void halLcd_ConfigIO(void);
static void halLcd_ConfigSPI(void);
static void SPI_SendData(uint8 x);
static uint32 mypow(uint8 m,uint8 n);
void LCD_WR_DATA(uint16 val); //指定数据
void LCD_WR_REG(uint16 reg);  //指定寄存器
void LCD_WR_REG_DATA(uint16 REG, uint16 VALUE);
static void LCD_ShowChar(uint16 x,uint16 y,uint16 num);

void HalLcdInit(void);
void LCD_Clear(uint32 color);
void LCD_DisplayOn(void);
void LCD_DisplayOff(void);
void LCD_XYRAM(uint16 xstart ,uint16 ystart ,uint16 xend ,uint16 yend);
void LCD_SetC(uint16 x, uint16 y);
void LCD_DrawPoint(uint16 x,uint16 y);
void LCD_DrawCircle(uint8 x0, uint16 y0, uint8 r);
void LCD_DrawLine(uint16 x1, uint16 y1, uint16 x2, uint16 y2);
void LCD_DrawRectage(uint16 xstart,uint16 ystart,uint16 xend,uint16 yend,uint16 color);
void LCD_Fill(uint16 xstart ,uint16 ystart ,uint16 xend ,uint16 yend ,uint16 color);
void LCD_ShowNum(uint8 x,uint16 y,uint32 num,uint8 len);
void LCD_ShowString(uint16 x,uint16 y,uint8 *p);

#endif 

//配置IO口
static void halLcd_ConfigIO(void)
{
  HAL_CONFIG_IO_OUTPUT(HAL_LCD_CS_PORT,   HAL_LCD_CS_PIN,  1);
  HAL_CONFIG_IO_OUTPUT(HAL_LCD_RS_PORT,   HAL_LCD_RS_PIN,  1);
  HAL_CONFIG_IO_OUTPUT(HAL_LCD_WR_PORT,   HAL_LCD_WR_PIN,  1);
  HAL_CONFIG_IO_OUTPUT(HAL_LCD_RD_PORT,   HAL_LCD_RD_PIN,  1);
  HAL_CONFIG_IO_OUTPUT(HAL_LCD_RST_PORT,  HAL_LCD_RST_PIN, 1);
}
//配置SPI口
static void halLcd_ConfigSPI(void)
{
  /* UART/SPI Peripheral configuration */
   uint8 baud_exponent;
   uint8 baud_mantissa;

  /* Set SPI on UART 1 alternative 2 */
  PERCFG |= 0x02;

  /* Configure clk, master out and master in lines */
  HAL_CONFIG_IO_PERIPHERAL(HAL_LCD_CLK_PORT,  HAL_LCD_CLK_PIN);
  HAL_CONFIG_IO_PERIPHERAL(HAL_LCD_MOSI_PORT, HAL_LCD_MOSI_PIN);
  HAL_CONFIG_IO_PERIPHERAL(HAL_LCD_MISO_PORT, HAL_LCD_MISO_PIN);
  
  baud_exponent = 19; //1M
  baud_mantissa = 100;

  /* Configure SPI */
  U1UCR  = 0x80;      /* Flush and goto IDLE state. 8-N-1. */
  U1CSR  = 0x00;      /* SPI mode, master. */
  U1GCR  = HAL_SPI_TRANSFER_MSB_FIRST | HAL_SPI_CLOCK_PHA_0 | HAL_SPI_CLOCK_POL_LO | baud_exponent;
  U1BAUD = baud_mantissa;
}

static void SPI_SendData(uint8 x)
{
  LCD_SPI_TX(x);
}
//初始化Lcd
void HalLcdInit(void)
{
  halLcd_ConfigIO();
  halLcd_ConfigSPI();
  LCD_RST = 0;
  MicroWait(600); 
  LCD_RST = 1;
  MicroWait(60000); 
  LCD_WR_REG_DATA(0x0001, 0x0100); // set SS and SM bit
  LCD_WR_REG_DATA(0x0002, 0x0200); // set 1 line inversion
  LCD_WR_REG_DATA(0x0003, 0x1030); // set GRAM write direction and BGR=1.
  LCD_WR_REG_DATA(0x0004, 0x0000); // Resize register
  LCD_WR_REG_DATA(0x0008, 0x0207); // set the back porch and front porch
  LCD_WR_REG_DATA(0x0009, 0x0000); // set non-display area refresh cycle ISC[3:0]
  LCD_WR_REG_DATA(0x000A, 0x0000); // FMARK function
  LCD_WR_REG_DATA(0x000C, 0x0000); // RGB interface setting
  LCD_WR_REG_DATA(0x000D, 0x0000); // Frame marker Position
  LCD_WR_REG_DATA(0x000F, 0x0000); // RGB interface polarity
	//*************Power On sequence ****************//
  LCD_WR_REG_DATA(0x0010, 0x0000); // SAP, BT[3:0], AP, DSTB, SLP, STB
  LCD_WR_REG_DATA(0x0011, 0x0007); // DC1[2:0], DC0[2:0], VC[2:0]
  LCD_WR_REG_DATA(0x0012, 0x0000); // VREG1OUT voltage
  LCD_WR_REG_DATA(0x0013, 0x0000); // VDV[4:0] for VCOM amplitude
  LCD_WR_REG_DATA(0x0007, 0x0001);
  MicroWait(200);
  LCD_WR_REG_DATA(0x0010, 0x1690); // SAP, BT[3:0], AP, DSTB, SLP, STB
  LCD_WR_REG_DATA(0x0011, 0x0227); // Set DC1[2:0], DC0[2:0], VC[2:0]
  MicroWait(50);
  LCD_WR_REG_DATA(0x0012, 0x000D); // 0012
  MicroWait(50);
  LCD_WR_REG_DATA(0x0013, 0x1200); // VDV[4:0] for VCOM amplitude
  LCD_WR_REG_DATA(0x0029, 0x000A); // 04  VCM[5:0] for VCOMH
  LCD_WR_REG_DATA(0x002B, 0x000D); // Set Frame Rate
  MicroWait(50);
  LCD_WR_REG_DATA(0x0020, 0x0000); // GRAM horizontal Address
  LCD_WR_REG_DATA(0x0021, 0x0000); // GRAM Vertical Address
	// ----------- Adjust the Gamma Curve ----------//
  LCD_WR_REG_DATA(0x0030, 0x0000);
  LCD_WR_REG_DATA(0x0031, 0x0404);
  LCD_WR_REG_DATA(0x0032, 0x0003);
  LCD_WR_REG_DATA(0x0035, 0x0405);
  LCD_WR_REG_DATA(0x0036, 0x0808);
  LCD_WR_REG_DATA(0x0037, 0x0407);
  LCD_WR_REG_DATA(0x0038, 0x0303);
  LCD_WR_REG_DATA(0x0039, 0x0707);
  LCD_WR_REG_DATA(0x003C, 0x0504);
  LCD_WR_REG_DATA(0x003D, 0x0808);
	//------------------ Set GRAM area ---------------//
  LCD_WR_REG_DATA(0x0050, 0x0000); // Horizontal GRAM Start Address
  LCD_WR_REG_DATA(0x0051, 0x00EF); // Horizontal GRAM End Address
  LCD_WR_REG_DATA(0x0052, 0x0000); // Vertical GRAM Start Address
  LCD_WR_REG_DATA(0x0053, 0x013F); // Vertical GRAM Start Address
  LCD_WR_REG_DATA(0x0060, 0xA700); // Gate Scan Line
  LCD_WR_REG_DATA(0x0061, 0x0001); // NDL,VLE, REV
	
  LCD_WR_REG_DATA(0x006A, 0x0000); // set scrolling line
	//-------------- Partial Display Control ---------//
  LCD_WR_REG_DATA(0x0080, 0x0000);
  LCD_WR_REG_DATA(0x0081, 0x0000);
  LCD_WR_REG_DATA(0x0082, 0x0000);
  LCD_WR_REG_DATA(0x0083, 0x0000);
  LCD_WR_REG_DATA(0x0084, 0x0000);
  LCD_WR_REG_DATA(0x0085, 0x0000);
	//-------------- Panel Control -------------------//
  LCD_WR_REG_DATA(0x0090, 0x0010);
  LCD_WR_REG_DATA(0x0092, 0x0000);
  LCD_WR_REG_DATA(0x0007, 0x0133); // 262K color and display ON
  //MicroWait(200);
  //LCD_Clear(WHITE); //绿色
}

/***************************************************/
/* 函数功能；给ILI9325的寄存器写数据               */
/* 入口参数；val：16位数据                         */
/* 说明：    写16位数据，学习板上的LCD采用8位连接，*/
/*           所以，16位数据分两次写进寄存器，先写高*/
/*           位，再写低位。                        */
/* 注意：使用时需要先使用LCD_WR_REG(reg)选择要把数 */
/*       据写到哪个寄存器里面。                    */
/***************************************************/
void LCD_WR_DATA(uint16 val)
{  
  LCD_RS = 1;  //RS=1;
  P1_4 = 0;	//CS=0;
  SPI_SendData(val>>8);						
  LCD_WR = 0;	//WR=0;
  LCD_WR = 1;   //WR=1;
  SPI_SendData(val);					
  LCD_WR = 0;	//WR=0;
  LCD_WR = 1;   //WR=1;
  LCD_CS = 1;	//CS=1;	
}

/****************************************************/
/* 函数功能：确定往哪个寄存器写数                   */
/* 入口参数；reg：选择的寄存器                      */
/* 说明：    寄存器号是16位数，8位连接方式需要写两次*/
/****************************************************/
void LCD_WR_REG(uint16 reg)		
{	
  LCD_RS = 0;	//RS=0;
  LCD_CS = 0;	//CS=0;
  SPI_SendData(reg>>8);
  LCD_WR = 0;	//WR=0;
  LCD_WR = 1;   //WR=1;
  SPI_SendData(reg);	
  LCD_WR = 0;	//WR=0;
  LCD_WR = 1;   //WR=1;
  LCD_RS = 1;	//RS=1;		
}

/******************************************************/
/* 函数功能；先选择寄存器号，再写数据到里面           */
/* 入口参数；REG：寄存器号  VALUE：数据值             */
/* 说明：    该函数是前两个函数的合成，也就是上面两个 */
/*           函数一般的用法就是这样组合。             */
/******************************************************/
void LCD_WR_REG_DATA(uint16 REG, uint16 VALUE)
{
   LCD_WR_REG(REG);
   LCD_WR_DATA(VALUE);   
}
//清屏幕函数
void LCD_Clear(uint32 color)
{
  uint32 temp;
  LCD_WR_REG_DATA(0x0020,0);//设置X坐标位置
  LCD_WR_REG_DATA(0x0021,0);//设置Y坐标位置
  LCD_WR_REG(0x0022);				//指向RAM寄存器，准备写数据到RAM
  for(temp=0;temp<76800;temp++)
  {
    LCD_WR_DATA(color);    
  }
}
/**********************************************/
/* 函数功能；开启显示                         */
/* 说    明：一般用于关闭显示后的开启         */
/**********************************************/
void LCD_DisplayOn(void)
{
 	LCD_WR_REG_DATA(0x0007, 0x0133); // 开启显示
}
/**********************************************/
/* 函数功能；关闭显示                         */
/* 说    明：并不是使TFT黑屏，而是使得TFT上的 */
/*           内容保持不变，一般用于TFT的数据线*/
/*           和其它模块连接，操作其它模块的时 */
/*           候不希望影响TFT的显示。          */
/**********************************************/
void LCD_DisplayOff(void)
{
	LCD_WR_REG_DATA(0x0007, 0x0); // 关闭显示
}
/***************************************************/
/* 函数功能；设置显存区域                          */
/* 说    明：设置将要显示的显存XY起始和结束坐标    */
/* 注    意：用完以后要恢复起点(0,0)和终点(239,319)*/
/***************************************************/
void LCD_XYRAM(uint16 xstart ,uint16 ystart ,uint16 xend ,uint16 yend)
{
	LCD_WR_REG_DATA(0x0050, xstart); // 设置横坐标GRAM起始地址
	LCD_WR_REG_DATA(0x0051, xend); // 设置横坐标GRAM结束地址
	LCD_WR_REG_DATA(0x0052, ystart); // 设置纵坐标GRAM起始地址
	LCD_WR_REG_DATA(0x0053, yend); // 设置纵坐标GRAM结束地址
}

/*******************************************************/
/* 函数功能：设置TFT屏起始坐标                         */
/*******************************************************/
void LCD_SetC(uint16 x, uint16 y)
{
	LCD_WR_REG_DATA(0x0020,x);  //设置X坐标位置
	LCD_WR_REG_DATA(0x0021,y);  //设置Y坐标位置
}
/******************************************/
/* 函数功能：画一个像素的点               */
/* 入口参数：x,y   点的坐标               */
/******************************************/
void LCD_DrawPoint(uint16 x,uint16 y)
{
  LCD_WR_REG_DATA(0x0020,x);//设置X坐标位置
  LCD_WR_REG_DATA(0x0021,y);//设置Y坐标位置
  LCD_WR_REG(0x0022);       //开始写入GRAM
  LCD_WR_DATA(PointColor); 
}
/**********************************************/
/* 函数功能；画直线                           */
/**********************************************/
void LCD_DrawLine(uint16 x1, uint16 y1, uint16 x2, uint16 y2)
{
	uint16 t; 
	int xerr=0,yerr=0,delta_x,delta_y,distance; 
	int incx,incy,uRow,uCol; 

	delta_x=x2-x1; //计算坐标增量 
	delta_y=y2-y1; 
	uRow=x1; 
	uCol=y1; 
	if(delta_x>0)incx=1; //设置单步方向 
	else if(delta_x==0)incx=0;//垂直线 
	else {incx=-1;delta_x=-delta_x;} 
	if(delta_y>0)incy=1; 
	else if(delta_y==0)incy=0;//水平线 
	else{incy=-1;delta_y=-delta_y;} 
	if( delta_x>delta_y)distance=delta_x; //选取基本增量坐标轴 
	else distance=delta_y; 
	for(t=0;t<=distance+1;t++ )//画线输出 
	{  
		LCD_DrawPoint(uRow,uCol);//画点 
		xerr+=delta_x ; 
		yerr+=delta_y ; 
		if(xerr>distance) 
		{ 
			xerr-=distance; 
			uRow+=incx; 
		} 
		if(yerr>distance) 
		{ 
			yerr-=distance; 
			uCol+=incy; 
		} 
	}  
}
/**********************************************/
/* 函数功能；画矩形                           */
/**********************************************/
void LCD_DrawRectage(uint16 xstart,uint16 ystart,uint16 xend,uint16 yend,uint16 color)
{
	PointColor=color;
	LCD_DrawLine(xstart, ystart, xend, ystart);
	LCD_DrawLine(xstart, yend, xend, yend);
	LCD_DrawLine(xstart, ystart, xstart, yend);
	LCD_DrawLine(xend, ystart, xend, yend);
}
/**********************************************/
/* 函数功能；矩形填充                         */
/**********************************************/
void LCD_Fill(uint16 xstart ,uint16 ystart ,uint16 xend ,uint16 yend ,uint16 color)
{                    
    uint32 max;
	LCD_XYRAM(xstart ,ystart ,xend ,yend); // 设置GRAM坐标
	LCD_WR_REG_DATA(0x0020,xstart);//设置X坐标位置
    LCD_WR_REG_DATA(0x0021,ystart);//设置Y坐标位置
    LCD_WR_REG(0x0022);				//指向RAM寄存器，准备写数据到RAM
	max=(uint32)((xend-xstart+1)*(yend-ystart+1));    
	while(max--)
	{
		LCD_WR_DATA(color);
	}
	LCD_XYRAM(0x0000 ,0x0000 ,0x00EF ,0X013F); // 恢复GRAM整屏显示
}
/*******************************************/
/* 函数功能：画圆                          */
/* 入口参数：x0,y0  圆心坐标               */
/*           r      半径(单位：像素)       */
/*******************************************/
void LCD_DrawCircle(uint8 x0, uint16 y0, uint8 r)
{
	int a,b;
	int di;
	a=0;b=r;	  
	di=3-(r<<1);             //判断下个点位置的标志
	while(a<=b)
	{
		LCD_DrawPoint(x0-b,y0-a);             //3           
		LCD_DrawPoint(x0+b,y0-a);             //0           
		LCD_DrawPoint(x0-a,y0+b);             //1       
		LCD_DrawPoint(x0-b,y0-a);             //7           
		LCD_DrawPoint(x0-a,y0-b);             //2             
		LCD_DrawPoint(x0+b,y0+a);             //4               
		LCD_DrawPoint(x0+a,y0-b);             //5
		LCD_DrawPoint(x0+a,y0+b);             //6 
		LCD_DrawPoint(x0-b,y0+a);             
		a++;
		//使用Bresenham算法画圆     
		if(di<0)di +=4*a+6;	  
		else
		{
			di+=10+4*(a-b);   
			b--;
		} 
		LCD_DrawPoint(x0+a,y0+b);
	}
} 
/**********************************************/
/* 函数功能；求m的n次方                       */
/**********************************************/
uint32 mypow(uint8 m,uint8 n)
{
	uint32 result=1;	 
	while(n--)result*=m;    
	return result;
}			 
/**********************************************/
/* 函数功能：显示数字                         */
/* 入口参数：x,y :起点坐标	 	              */
/*           len :数字的位数				  */
/*           num:数值(0~4294967295);	   	  */
/**********************************************/
void LCD_ShowNum(uint8 x,uint16 y,uint32 num,uint8 len)
{         	
	uint8 t,temp;
	uint8 enshow=0;		 // 此变量用来去掉最高位的0	
				   
	for(t=0;t<len;t++)
	{
		temp=(num/mypow(10,len-t-1))%10;
		if(enshow==0&&t<(len-1))
		{
			if(temp==0)
			{
				LCD_ShowChar(x+8*t,y,' ');
				continue;
			}else enshow=1; 
		 	 
		}
	 	LCD_ShowChar(x+8*t,y,temp+'0'); 
	}
} 
/**********************************************/
/* 函数功能：显示8*16点阵英文字符             */
/* 入口参数：x,y :起点坐标	 	              */
/*           num:字母或符号         	   	  */
/* 注    意：x,y的取值要在240到320范围内      */
/**********************************************/
void LCD_ShowChar(uint16 x,uint16 y,uint16 num)
{
    uint8 temp;
    uint8 pos,t;
	      
    LCD_WR_REG_DATA(0x0020,x);//设置X坐标位置
    LCD_WR_REG_DATA(0x0021,y);//设置Y坐标位置
 	/*开辟显存区域*/
    LCD_XYRAM(x,y,x+7,y+15); // 设置GRAM坐标
    LCD_WR_REG(0x0022);	  	 //指向RAM寄存器，准备写数据到RAM
 	
	num=num-' ';//得到偏移后的值
	for(pos=0;pos<16;pos++)
	{
	    temp=ascii_16[num][pos];
	    for(t=0;t<8;t++)
	    {                 
	        if(temp&0x80)LCD_WR_DATA(PointColor);
	        else LCD_WR_DATA(BackColor);    
	        temp<<=1; 
	    }
	}
	/* 恢复显存显示区域240*320 */
	LCD_XYRAM(0x0000 ,0x0000 ,0x00EF ,0X013F); // 恢复GRAM整屏显示
}
/*********************************************/
/* 函数功能：显示字符串（中文和英文）        */
/* 入口参数：x,y: 坐标                       */
/*           *p:字符串                       */
/*********************************************/
void LCD_ShowString(uint16 x,uint16 y,uint8 *p)
{         
    while(*p!='\0')	// 如果没有结束
    {       
	if((*p=='\n')||(x>224))   // 换段和换行
	{
		y=y+19;   //字体高16 行间距3
		x=2;      //2是边距
	}
	LCD_ShowChar(x,y,*p);
	x+=8;
	p++;
    }  
}

#endif

